server {
  listen 80;

  rewrite ^(.*) https://$host$1 permanent;
}


# https://github.com/igrigorik/istlsfastyet.com/blob/master/nginx/includes/ssl.conf
server {
  listen 443 ssl spdy;

  # Adjust connection keepalive for SPDY and non-SPDY clients:
  spdy_keepalive_timeout 300; # up from 180 secs default
  keepalive_timeout 300; # up from 75 secs default

  ssl on;
  ssl_certificate /home/app/tls/ssl.crt;
  ssl_certificate_key /home/app/tls/ssl.key;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;  # 10MB -> ~40,000 sessions.
  ssl_session_timeout 24h;           # 24 hours
  ssl_buffer_size 1400;              # 1400 bytes to fit in one MTU

  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK:!RC4;

  # OCSP stapling...
#  ssl_stapling on;
#  ssl_stapling_verify on;
#  ssl_trusted_certificate /home/app/tls/ca.crt;
#  resolver 8.8.8.8;

  # nginx does not auto-rotate session ticket keys: only a HUP / restart will do so and
  # when a restart is performed the previous key is lost, which resets all previous
  # sessions. The fix for this is to setup a manual rotation mechanism:
  # http://trac.nginx.org/nginx/changeset/1356a3b9692441e163b4e78be4e9f5a46c7479e9/nginx
  #
  # Note that you'll have to define and rotate the keys securely by yourself. In absence
  # of such infrastructure, consider turning off session tickets:
#  ssl_session_ticket_key /home/app/tls/session_ticket.key;
#  ssl_session_tickets on;
  ssl_session_tickets off;

  spdy_headers_comp 6;
  add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains';

  # cache
  # Set expires max on static file types (make sure you are using cache busting filenames or query params):
  location ~* ^.+\.(css|js|jpg|jpeg|gif|png|ico|gz|svg|svgz|ttf|otf|woff|eot|mp4|ogg|ogv|webm|pdf)$ {
    expires max;
    access_log off;
  }

  # app config
  root /home/app/webapp/public;

  passenger_enabled on;
  passenger_user app;
  passenger_ruby /usr/bin/ruby2.2;
}
